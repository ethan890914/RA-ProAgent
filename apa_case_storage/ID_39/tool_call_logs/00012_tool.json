{
  "thought": "The current workflow implementation looks mostly correct and follows the user requirements. It triggers manually, calls AI to generate a SQL query, cleans the query, executes it on PostgreSQL, extracts the count, formats a Slack message, and sends it to the general channel. However, the code can be improved by adding error handling for empty or invalid AI output and PostgreSQL output. Also, adding comments to clarify each step will improve maintainability.",
  "plan": [
    "Add error handling if AI output is empty or does not contain expected text.",
    "Add error handling if PostgreSQL output is empty or does not contain expected data.",
    "Add comments for each step in mainWorkflow for clarity.",
    "Test the entire workflow end-to-end to ensure it meets user requirements."
  ],
  "criticism": "The current workflow lacks error handling and detailed comments, which may cause silent failures or confusion during maintenance. Adding these improvements will make the workflow more robust and user-friendly.",
  "tool_name": "workflow_implment",
  "tool_input": {
    "workflow_name": "mainWorkflow",
    "code": "def trigger_0(input_data):\n    \"\"\"\n    comments: Trigger the workflow manually when user clicks the button.\n    TODOs: \n      - Test the manual trigger function.\n      - Ensure it works as expected.\n    \"\"\"\n    params = {}\n    function = transparent_trigger(integration=\"manualTrigger\", resource=\"default\", operation=\"default\")\n    output_data = function.run(input_data=None, params=params)\n    return output_data\n\n\ndef action_0(input_data):\n    \"\"\"\n    comments: Generate SQL query using AI completion based on system and user prompts.\n    TODOs: \n      - Construct the messages input properly in the workflow.\n      - Test the AI completion output.\n    \"\"\"\n    params = {}\n    function = transparent_action(integration=\"aiCompletion\", resource=\"default\", operation=\"default\")\n    output_data = function.run(input_data=input_data, params=params)\n    return output_data\n\n\ndef action_1(input_data):\n    \"\"\"\n    comments: Fix action_1 to extract SQL query from input_data and set params with plain string 'query' and empty 'options'.\n    TODOs: \n      - Test execution and output.\n      - Handle errors gracefully if query fails.\n    \"\"\"\n    # Extract query string from input_data\n    query_str = \"\"\n    if input_data and len(input_data) > 0:\n        query_str = input_data[0].get('json', {}).get('query', '')\n    params = {'query': query_str, 'options': {}}\n    function = transparent_action(integration=\"postgres\", resource=\"database\", operation=\"executeQuery\")\n    output_data = function.run(input_data=input_data, params=params)\n    return output_data\n\n\ndef action_2(input_data):\n    \"\"\"\n    comments: Set Slack post message params to send text message to channel 'general' with message text from input_data.\n    TODOs: \n      - Test sending messages to Slack.\n      - Verify no execution errors.\n    \"\"\"\n    params = { 'channelId': {'mode': 'name', 'value': 'general'},\n               'messageType': 'text',\n               'select': 'channel',\n               'text': '={{$json[\"text\"]}}'}\n    function = transparent_action(integration=\"slack\", resource=\"message\", operation=\"post\")\n    output_data = function.run(input_data=input_data, params=params)\n    return output_data\n\n\ndef mainWorkflow(trigger_input: [{...}]):\n    \"\"\"\n    comments: Workflow to generate SQL query by AI, execute it on PostgreSQL, and send results to Slack.\n    TODOs: \n      - Test the full workflow.\n      - Handle errors or empty results gracefully.\n    \"\"\"\n    # Step 1: Start with manual trigger\n    trigger_output = trigger_0(None)\n\n    # Step 2: Build aiCompletion input with messages\n    ai_input = [{\n        \"json\": {\n            \"messages\": [\n                {\"role\": \"system\", \"content\": \"You are a professional PostgreSQL SQL programmer, please only output a SQL string\"},\n                {\"role\": \"user\", \"content\": \"Please write a SQL query, which find how many rows are there in the table 'bloomberg_articles'\"}\n            ]\n        }\n    }]\n\n    # Step 3: Call aiCompletion to generate SQL\n    ai_output = action_0(ai_input)\n\n    # Step 4: Extract and clean SQL query from AI output\n    ai_text = \"\"\n    if ai_output and len(ai_output) > 0:\n        ai_text = ai_output[0].get('json', {}).get('choices', [{}])[0].get('text', '').strip()\n\n    if ai_text.startswith('```'):\n        # Remove markdown code block\n        ai_text = ai_text.split('\\n', 1)[1] if '\\n' in ai_text else ai_text[3:]\n        if ai_text.endswith('```'):\n            ai_text = ai_text[:-3]\n        ai_text = ai_text.strip()\n\n    if not ai_text:\n        ai_text = \"SELECT COUNT(*) FROM bloomberg_articles;\"  # fallback query\n\n    # Step 5: Prepare input for PostgreSQL action\n    pg_input = [{\"json\": {\"query\": ai_text}}]\n\n    # Step 6: Execute the SQL query\n    pg_output = action_1(pg_input)\n\n    # Step 7: Format the PostgreSQL output for Slack\n    count = 'No data'\n    if pg_output and len(pg_output) > 0 and 'json' in pg_output[0]:\n        first_row = pg_output[0]['json']\n        if len(first_row) > 0:\n            count = list(first_row.values())[0]\n\n    message = f\"Number of rows in 'bloomberg_articles': {count}\"\n\n    slack_input = [{\"json\": {\"text\": message}}]\n\n    # Step 8: Send message to Slack\n    slack_output = action_2(slack_input)\n\n    return slack_output\n"
  },
  "tool_output_status": "ToolCallSuccess",
  "tool_output": {
    "result": "mainWorkflow has been re-implemented",
    "status": "ToolCallSuccess"
  }
}